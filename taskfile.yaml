version: "3"

tasks:
  build:
    dir: function
    cmds:
      - rm -rf ./bin
      - GOOS="linux" GOARCH="amd64" go build -o ./bin/main ./src/main.go
    silent: false

  run-locally:
    dir: function
    env:
      COSMOS_HOST: localhost
      COSMOS_DATABASE: local
      COSMOS_CONTAINER: local
    cmds:
      - GOOS="darwin" GOARCH="arm64" go build -o ./bin/main-arm64 ./src/main.go
      - ./bin/main-arm64
    silent: false

  deploy-function:
    deps: [build]
    dir: function
    cmds:
      - func azure functionapp publish cwa-quotes-prod-func --custom
    silent: false

  deploy-infra:
    description: Deploy the current infrastructure code
    dir: terraform
    cmds:
      - terraform init
      - terraform apply

  deploy-all:
    description: Deploy the current code and infrastructure
    tasks:
      - deploy-infra
      - deploy-function
